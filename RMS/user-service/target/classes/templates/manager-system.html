<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f5f5f5; color: #333; }
        .header { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; }
        .user-info { display: flex; gap: 15px; align-items: center; }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .tabs { display: flex; background: white; border-radius: 5px; overflow: hidden; margin-bottom: 20px; }
        .tab { padding: 12px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { background: #3498db; color: white; border-color: #2980b9; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 5px; }
        .tab-content.active { display: block; }
        .section-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th { background: #2c3e50; color: white; padding: 10px; }
        .data-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 5px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-value { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 5px; width: 90%; max-width: 500px; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .message { padding: 10px; border-radius: 4px; margin-bottom: 15px; display: none; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
<!-- Header -->
<div class="header">
    <h1>üëî Manager System</h1>
    <div class="user-info">
        <div id="welcomeUser">Manager</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
</div>

<!-- Container -->
<div class="container">
    <!-- Messages -->
    <div id="successMessage" class="message success"></div>
    <div id="errorMessage" class="message error"></div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
        <div class="tab" onclick="switchTab('staff')">üë• Staff</div>
        <div class="tab" onclick="switchTab('menu')">üìã Menu</div>
        <div class="tab" onclick="switchTab('inventory')">üì¶ Inventory</div>
        <div class="tab" onclick="switchTab('sales')">üí∞ Reports</div>
    </div>

    <!-- TAB 1: Dashboard -->
    <div id="dashboard-tab" class="tab-content active">
        <div class="section-header">
            <h2>Restaurant Dashboard</h2>
            <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ Refresh</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div>Total Staff</div>
                <div class="stat-value" id="totalStaff">0</div>
            </div>

            <div class="stat-card">
                <div>Today's Revenue</div>
                <div class="stat-value" id="todayRevenue">Rs. 0</div>
                <div><span id="todayBillsCount">0</span> bills</div>
            </div>

            <div class="stat-card">
                <div>Menu Items</div>
                <div class="stat-value" id="menuItemsCount">0</div>
                <div><span id="availableMenuCount">0</span> available</div>
            </div>

            <div class="stat-card">
                <div>Active Orders</div>
                <div class="stat-value" id="activeOrdersCount">0</div>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-success" onclick="showAddStaffModal()">‚ûï Add Staff</button>
            <button class="btn btn-success" onclick="showAddMenuItemModal()">‚ûï Add Menu Item</button>
            <button class="btn btn-primary" onclick="switchTab('sales')">üìä View Reports</button>
        </div>
    </div>

    <!-- TAB 2: Staff Management -->
    <div id="staff-tab" class="tab-content">
        <div class="section-header">
            <h2>Staff Management</h2>
            <button class="btn btn-success" onclick="showAddStaffModal()">‚ûï Add Staff</button>
        </div>

        <div id="loadingStaff">Loading staff...</div>
        <table class="data-table" id="staffTable" style="display: none;">
            <thead>
            <tr>
                <th>Username</th>
                <th>Full Name</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="staffTableBody"></tbody>
        </table>
    </div>

    <!-- TAB 3: Menu Management -->
    <div id="menu-tab" class="tab-content">
        <div class="section-header">
            <h2>Menu Management</h2>
            <button class="btn btn-success" onclick="showAddMenuItemModal()">‚ûï Add Menu Item</button>
        </div>

        <div id="loadingMenu">Loading menu...</div>
        <table class="data-table" id="menuTable" style="display: none;">
            <thead>
            <tr>
                <th>Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="menuTableBody"></tbody>
        </table>
    </div>

    <!-- TAB 4: Inventory -->
    <div id="inventory-tab" class="tab-content">
        <div class="section-header">
            <h2>Inventory Management</h2>
            <button class="btn btn-success" onclick="showAddIngredientModal()">‚ûï Add Ingredient</button>
        </div>

        <div id="loadingInventory">Loading inventory...</div>
        <table class="data-table" id="inventoryTable" style="display: none;">
            <thead>
            <tr>
                <th>Ingredient</th>
                <th>Stock</th>
                <th>Unit</th>
                <th>Min Level</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody id="inventoryTableBody"></tbody>
        </table>
    </div>

    <!-- TAB 5: Sales Reports -->
    <div id="sales-tab" class="tab-content">
        <div class="section-header">
            <h2>Sales Reports</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="generateDailyReport()">üìÖ Daily</button>
                <button class="btn" onclick="generateWeeklyReport()">üìÜ Weekly</button>
                <button class="btn" onclick="generateMonthlyReport()">üìÖ Monthly</button>
                <button class="btn" onclick="loadAllBills()">üìä All Bills</button>
            </div>
        </div>

        <div id="reportResults">
            Select report type above
        </div>

        <div id="reportActions" style="margin-top: 20px; display: none;">
            <button class="btn btn-success" onclick="printReport()">üñ®Ô∏è Print</button>
            <button class="btn btn-primary" onclick="downloadReport()">üì• Download</button>
        </div>
    </div>
</div>

<!-- MODALS -->
<!-- Add Staff Modal -->
<div id="addStaffModal" class="modal">
    <div class="modal-content">
        <h3>Add Staff</h3>
        <form id="addStaffForm">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="newUsername" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="newPassword" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="newFullName" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="newRole" class="form-control" required>
                    <option value="WAITER">Waiter</option>
                    <option value="CHEF">Chef</option>
                    <option value="CASHIER">Cashier</option>
                    <option value="MANAGER">Manager</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button type="button" class="btn btn-success" onclick="addNewStaff()">Add</button>
                <button type="button" class="btn" onclick="closeModal('addStaffModal')">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Menu Item Modal -->
<div id="addMenuItemModal" class="modal">
    <div class="modal-content">
        <h3>Add Menu Item</h3>
        <form id="addMenuItemForm">
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" id="newItemName" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="newCategory" class="form-control" required>
                    <option value="APPETIZERS">Appetizers</option>
                    <option value="MAIN_COURSE">Main Course</option>
                    <option value="DESSERTS">Desserts</option>
                    <option value="BEVERAGES">Beverages</option>
                </select>
            </div>
            <div class="form-group">
                <label>Price (Rs.)</label>
                <input type="number" id="newPrice" class="form-control" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="newDescription" class="form-control" rows="3"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button type="button" class="btn btn-success" onclick="addMenuItem()">Add</button>
                <button type="button" class="btn" onclick="closeModal('addMenuItemModal')">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Ingredient Modal -->
<div id="addIngredientModal" class="modal">
    <div class="modal-content">
        <h3>Add Ingredient</h3>
        <form id="addIngredientForm">
            <div class="form-group">
                <label>Ingredient Name</label>
                <input type="text" id="newIngredientName" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Current Quantity</label>
                <input type="number" id="newQuantity" class="form-control" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Unit</label>
                <select id="newUnit" class="form-control" required>
                    <option value="KG">KG</option>
                    <option value="L">L</option>
                    <option value="PIECES">Pieces</option>
                </select>
            </div>
            <div class="form-group">
                <label>Min Level</label>
                <input type="number" id="newMinLevel" class="form-control" step="0.01" required>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button type="button" class="btn btn-success" onclick="addIngredient()">Add</button>
                <button type="button" class="btn" onclick="closeModal('addIngredientModal')">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentUser = null;
    let allStaff = [];
    let allMenuItems = [];
    let allIngredients = [];
    let allBills = [];
    let currentReportData = null;

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        checkLoginStatus();
    });

    function checkLoginStatus() {
        const userData = localStorage.getItem('restaurantUser');
        if (!userData) {
            window.location.href = '/';
            return;
        }

        try {
            currentUser = JSON.parse(userData);
            if (currentUser.role !== 'MANAGER') {
                localStorage.removeItem('restaurantUser');
                window.location.href = '/';
                return;
            }

            document.getElementById('welcomeUser').textContent = `Manager: ${currentUser.fullName}`;
            refreshDashboard();
        } catch (error) {
            localStorage.removeItem('restaurantUser');
            window.location.href = '/';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');

        switch(tabName) {
            case 'dashboard': refreshDashboard(); break;
            case 'staff': loadAllStaff(); break;
            case 'menu': loadAllMenuItems(); break;
            case 'inventory': loadAllInventory(); break;
            case 'sales': generateDailyReport(); break;
        }
    }

    // ==================== DASHBOARD ====================
    async function refreshDashboard() {
        try {
            const [staff, menu, orders, bills] = await Promise.all([
                fetch('http://localhost:8081/api/users').then(r => r.ok ? r.json() : []),
                fetch('http://localhost:8083/api/menu').then(r => r.ok ? r.json() : []),
                fetch('http://localhost:8084/api/orders').then(r => r.ok ? r.json() : []),
                fetch('http://localhost:8085/api/bills').then(r => r.ok ? r.json() : [])
            ]);

            updateDashboardStats(staff, menu, orders, bills);
        } catch (error) {
            console.error('Dashboard error:', error);
        }
    }

    function updateDashboardStats(staff, menu, orders, bills) {
        document.getElementById('totalStaff').textContent = staff.length;

        const today = new Date().toLocaleDateString('en-CA');
        const todayBills = bills.filter(bill => {
            if (!bill.billTime) return false;
            return new Date(bill.billTime).toLocaleDateString('en-CA') === today;
        });
        const todayRevenue = todayBills.reduce((sum, bill) => sum + (parseFloat(bill.totalAmount) || 0), 0);
        document.getElementById('todayRevenue').textContent = `Rs. ${todayRevenue.toFixed(2)}`;
        document.getElementById('todayBillsCount').textContent = todayBills.length;

        document.getElementById('menuItemsCount').textContent = menu.length;
        const available = menu.filter(item => item.isAvailable === true || item.isAvailable === 'true').length;
        document.getElementById('availableMenuCount').textContent = available;

        const activeOrders = orders.filter(order => order.status && !['COMPLETED', 'CANCELLED'].includes(order.status));
        document.getElementById('activeOrdersCount').textContent = activeOrders.length;
    }

    // ==================== STAFF MANAGEMENT ====================
    async function loadAllStaff() {
        try {
            const response = await fetch('http://localhost:8081/api/users');
            if (response.ok) {
                allStaff = await response.json();
                displayStaffTable();
            }
        } catch (error) {
            console.error('Staff error:', error);
        }
    }

    function displayStaffTable() {
        const tbody = document.getElementById('staffTableBody');
        tbody.innerHTML = '';

        allStaff.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.username}</td>
                <td>${user.fullName}</td>
                <td>${user.role}</td>
                <td>
                    <button class="btn" onclick="editStaff('${user.userId}')" style="padding: 5px 10px; font-size: 12px;">Edit</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('loadingStaff').style.display = 'none';
        document.getElementById('staffTable').style.display = 'table';
    }

    function showAddStaffModal() {
        document.getElementById('addStaffForm').reset();
        document.getElementById('addStaffModal').style.display = 'flex';
    }

    async function addNewStaff() {
        const username = document.getElementById('newUsername').value.trim();
        const password = document.getElementById('newPassword').value;
        const fullName = document.getElementById('newFullName').value.trim();
        const role = document.getElementById('newRole').value;

        if (!username || !password || !fullName) {
            showError('Please fill all fields');
            return;
        }

        try {
            const userData = { username, password, fullName, role };
            const response = await fetch('http://localhost:8081/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });

            if (response.ok) {
                showSuccess('Staff added!');
                closeModal('addStaffModal');
                loadAllStaff();
                refreshDashboard();
            } else {
                const error = await response.text();
                showError(error);
            }
        } catch (error) {
            showError('Error adding staff');
        }
    }

    async function editStaff(userId) {
        const newName = prompt('Enter new full name:');
        if (newName) {
            try {
                const response = await fetch(`http://localhost:8081/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fullName: newName })
                });
                if (response.ok) {
                    showSuccess('Staff updated!');
                    loadAllStaff();
                }
            } catch (error) {
                showError('Error updating staff');
            }
        }
    }

    // ==================== MENU MANAGEMENT ====================
    async function loadAllMenuItems() {
        try {
            const response = await fetch('http://localhost:8083/api/menu');
            if (response.ok) {
                allMenuItems = await response.json();
                displayMenuTable();
            }
        } catch (error) {
            console.error('Menu error:', error);
        }
    }

    function displayMenuTable() {
        const tbody = document.getElementById('menuTableBody');
        tbody.innerHTML = '';

        allMenuItems.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.itemName}</td>
                <td>${item.category || 'N/A'}</td>
                <td>Rs. ${parseFloat(item.price || 0).toFixed(2)}</td>
                <td>${(item.isAvailable === true || item.isAvailable === 'true') ? 'Available' : 'Unavailable'}</td>
                <td>
                    <button class="btn" onclick="editMenuItem('${item.itemId}')" style="padding: 5px 10px; font-size: 12px;">Edit</button>
                    <button class="btn" onclick="toggleMenuItem('${item.itemId}')" style="padding: 5px 10px; font-size: 12px;">
                        ${(item.isAvailable === true || item.isAvailable === 'true') ? 'Disable' : 'Enable'}
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('loadingMenu').style.display = 'none';
        document.getElementById('menuTable').style.display = 'table';
    }

    function showAddMenuItemModal() {
        document.getElementById('addMenuItemForm').reset();
        document.getElementById('addMenuItemModal').style.display = 'flex';
    }

    async function addMenuItem() {
        const itemName = document.getElementById('newItemName').value.trim();
        const category = document.getElementById('newCategory').value;
        const price = parseFloat(document.getElementById('newPrice').value);
        const description = document.getElementById('newDescription').value.trim();

        if (!itemName || !category || !price || price <= 0) {
            showError('Please fill all fields correctly');
            return;
        }

        try {
            const itemData = { itemName, category, price, description, isAvailable: true };
            const response = await fetch('http://localhost:8083/api/menu', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemData)
            });

            if (response.ok) {
                showSuccess('Menu item added!');
                closeModal('addMenuItemModal');
                loadAllMenuItems();
                refreshDashboard();
            } else {
                showError('Failed to add menu item');
            }
        } catch (error) {
            showError('Error adding menu item');
        }
    }

    async function toggleMenuItem(itemId) {
        try {
            const item = allMenuItems.find(m => m.itemId === itemId);
            if (!item) return;

            item.isAvailable = !(item.isAvailable === true || item.isAvailable === 'true');
            const response = await fetch(`http://localhost:8083/api/menu/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(item)
            });

            if (response.ok) {
                showSuccess('Menu item updated!');
                loadAllMenuItems();
            }
        } catch (error) {
            showError('Error updating menu item');
        }
    }

    async function editMenuItem(itemId) {
        const item = allMenuItems.find(m => m.itemId === itemId);
        if (!item) return;

        const newPrice = prompt(`Enter new price for "${item.itemName}":`, item.price);
        if (newPrice && !isNaN(newPrice) && parseFloat(newPrice) > 0) {
            try {
                item.price = parseFloat(newPrice);
                const response = await fetch(`http://localhost:8083/api/menu/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                });

                if (response.ok) {
                    showSuccess('Price updated!');
                    loadAllMenuItems();
                }
            } catch (error) {
                showError('Error updating price');
            }
        }
    }

    // ==================== INVENTORY MANAGEMENT ====================
    async function loadAllInventory() {
        try {
            // First, get menu items to show ingredients
            const menuResponse = await fetch('http://localhost:8083/api/menu');
            if (menuResponse.ok) {
                const menuItems = await menuResponse.json();

                // Create sample inventory based on menu items
                const sampleIngredients = [
                    { name: 'Chicken Breast', stock: 12.5, unit: 'KG', min: 10 },
                    { name: 'Beef', stock: 8.2, unit: 'KG', min: 8 },
                    { name: 'Rice', stock: 25.0, unit: 'KG', min: 20 },
                    { name: 'Tomatoes', stock: 4.5, unit: 'KG', min: 5 },
                    { name: 'Onions', stock: 6.0, unit: 'KG', min: 8 },
                    { name: 'Cheese', stock: 3.5, unit: 'KG', min: 5 }
                ];

                displayInventoryTable(sampleIngredients);
            }
        } catch (error) {
            console.error('Inventory error:', error);
        }
    }

    function displayInventoryTable(ingredients) {
        const tbody = document.getElementById('inventoryTableBody');
        tbody.innerHTML = '';

        ingredients.forEach(ing => {
            const row = document.createElement('tr');
            const status = ing.stock <= ing.min ? 'LOW' : 'OK';
            row.innerHTML = `
                <td>${ing.name}</td>
                <td>${ing.stock.toFixed(2)}</td>
                <td>${ing.unit}</td>
                <td>${ing.min.toFixed(2)}</td>
                <td style="color: ${status === 'LOW' ? '#e74c3c' : '#27ae60'}">${status}</td>
            `;
            tbody.appendChild(row);
        });

        document.getElementById('loadingInventory').style.display = 'none';
        document.getElementById('inventoryTable').style.display = 'table';
    }

    function showAddIngredientModal() {
        document.getElementById('addIngredientForm').reset();
        document.getElementById('addIngredientModal').style.display = 'flex';
    }

    function addIngredient() {
        showSuccess('Ingredient added (sample data)');
        closeModal('addIngredientModal');
        loadAllInventory();
    }

    // ==================== SALES REPORTS ====================
    async function generateDailyReport() {
        const container = document.getElementById('reportResults');
        container.innerHTML = 'Loading daily report...';

        try {
            const response = await fetch('http://localhost:8085/api/bills');
            if (response.ok) {
                allBills = await response.json();
                displayDailyReport(allBills);
            }
        } catch (error) {
            container.innerHTML = 'Error loading report';
        }
    }

    function displayDailyReport(bills) {
        const container = document.getElementById('reportResults');
        const today = new Date().toLocaleDateString('en-CA');

        const todayBills = bills.filter(bill => {
            if (!bill.billTime) return false;
            return new Date(bill.billTime).toLocaleDateString('en-CA') === today;
        });

        const totalRevenue = todayBills.reduce((sum, bill) => sum + (parseFloat(bill.totalAmount) || 0), 0);
        const cash = todayBills.filter(b => b.paymentMethod === 'CASH').length;
        const card = todayBills.filter(b => b.paymentMethod === 'CARD').length;

        currentReportData = {
            type: 'DAILY',
            date: new Date().toLocaleDateString(),
            bills: todayBills,
            stats: {
                totalBills: todayBills.length,
                totalRevenue: totalRevenue,
                cashCount: cash,
                cardCount: card
            }
        };

        let html = `
            <h3>üìÖ Daily Sales Report - ${new Date().toLocaleDateString()}</h3>
            <div style="background: #e8f4fc; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <p><strong>Total Bills:</strong> ${todayBills.length}</p>
                <p><strong>Total Revenue:</strong> Rs. ${totalRevenue.toFixed(2)}</p>
                <p><strong>Cash Payments:</strong> ${cash}</p>
                <p><strong>Card Payments:</strong> ${card}</p>
            </div>
        `;

        if (todayBills.length > 0) {
            html += `
                <h4>Today's Bills</h4>
                <table class="data-table">
                    <tr><th>Bill #</th><th>Time</th><th>Amount</th><th>Payment</th></tr>
            `;

            todayBills.forEach(bill => {
                const time = bill.billTime ? new Date(bill.billTime).toLocaleTimeString() : 'N/A';
                html += `
                    <tr>
                        <td>${bill.billId?.substring(0, 8) || 'N/A'}</td>
                        <td>${time}</td>
                        <td>Rs. ${parseFloat(bill.totalAmount || 0).toFixed(2)}</td>
                        <td>${bill.paymentMethod || 'N/A'}</td>
                    </tr>
                `;
            });

            html += '</table>';
        } else {
            html += '<p style="text-align: center; padding: 20px; color: #666;">No bills today</p>';
        }

        container.innerHTML = html;
        document.getElementById('reportActions').style.display = 'block';
    }

    async function generateWeeklyReport() {
        const container = document.getElementById('reportResults');
        container.innerHTML = 'Loading weekly report...';

        try {
            const response = await fetch('http://localhost:8085/api/bills');
            if (response.ok) {
                const bills = await response.json();
                displayWeeklyReport(bills);
            }
        } catch (error) {
            container.innerHTML = 'Error loading report';
        }
    }

    function displayWeeklyReport(bills) {
        const container = document.getElementById('reportResults');
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

        const weeklyBills = bills.filter(bill => {
            if (!bill.billTime) return false;
            return new Date(bill.billTime) >= oneWeekAgo;
        });

        const totalRevenue = weeklyBills.reduce((sum, bill) => sum + (parseFloat(bill.totalAmount) || 0), 0);
        const cash = weeklyBills.filter(b => b.paymentMethod === 'CASH').length;
        const card = weeklyBills.filter(b => b.paymentMethod === 'CARD').length;

        currentReportData = {
            type: 'WEEKLY',
            period: 'Last 7 Days',
            bills: weeklyBills,
            stats: {
                totalBills: weeklyBills.length,
                totalRevenue: totalRevenue,
                cashCount: cash,
                cardCount: card
            }
        };

        let html = `
            <h3>üìÜ Weekly Sales Report (Last 7 Days)</h3>
            <div style="background: #e8f4fc; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <p><strong>Total Bills:</strong> ${weeklyBills.length}</p>
                <p><strong>Total Revenue:</strong> Rs. ${totalRevenue.toFixed(2)}</p>
                <p><strong>Cash Payments:</strong> ${cash}</p>
                <p><strong>Card Payments:</strong> ${card}</p>
                <p><strong>Average Daily Revenue:</strong> Rs. ${(totalRevenue / 7).toFixed(2)}</p>
            </div>
        `;

        if (weeklyBills.length > 0) {
            html += `
                <h4>Recent Bills</h4>
                <table class="data-table">
                    <tr><th>Bill #</th><th>Date</th><th>Amount</th><th>Payment</th></tr>
            `;

            weeklyBills.slice(0, 10).forEach(bill => {
                const date = bill.billTime ? new Date(bill.billTime).toLocaleDateString() : 'N/A';
                html += `
                    <tr>
                        <td>${bill.billId?.substring(0, 8) || 'N/A'}</td>
                        <td>${date}</td>
                        <td>Rs. ${parseFloat(bill.totalAmount || 0).toFixed(2)}</td>
                        <td>${bill.paymentMethod || 'N/A'}</td>
                    </tr>
                `;
            });

            html += '</table>';
        } else {
            html += '<p style="text-align: center; padding: 20px; color: #666;">No bills this week</p>';
        }

        container.innerHTML = html;
        document.getElementById('reportActions').style.display = 'block';
    }

    async function generateMonthlyReport() {
        const container = document.getElementById('reportResults');
        container.innerHTML = 'Loading monthly report...';

        try {
            const response = await fetch('http://localhost:8085/api/bills');
            if (response.ok) {
                const bills = await response.json();
                displayMonthlyReport(bills);
            }
        } catch (error) {
            container.innerHTML = 'Error loading report';
        }
    }

    function displayMonthlyReport(bills) {
        const container = document.getElementById('reportResults');
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

        const monthlyBills = bills.filter(bill => {
            if (!bill.billTime) return false;
            return new Date(bill.billTime) >= oneMonthAgo;
        });

        const totalRevenue = monthlyBills.reduce((sum, bill) => sum + (parseFloat(bill.totalAmount) || 0), 0);
        const cash = monthlyBills.filter(b => b.paymentMethod === 'CASH').length;
        const card = monthlyBills.filter(b => b.paymentMethod === 'CARD').length;

        currentReportData = {
            type: 'MONTHLY',
            period: 'Last 30 Days',
            bills: monthlyBills,
            stats: {
                totalBills: monthlyBills.length,
                totalRevenue: totalRevenue,
                cashCount: cash,
                cardCount: card
            }
        };

        let html = `
            <h3>üìÖ Monthly Sales Report (Last 30 Days)</h3>
            <div style="background: #e8f4fc; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <p><strong>Total Bills:</strong> ${monthlyBills.length}</p>
                <p><strong>Total Revenue:</strong> Rs. ${totalRevenue.toFixed(2)}</p>
                <p><strong>Cash Payments:</strong> ${cash}</p>
                <p><strong>Card Payments:</strong> ${card}</p>
                <p><strong>Average Daily Revenue:</strong> Rs. ${(totalRevenue / 30).toFixed(2)}</p>
            </div>
        `;

        container.innerHTML = html;
        document.getElementById('reportActions').style.display = 'block';
    }

    async function loadAllBills() {
        const container = document.getElementById('reportResults');
        container.innerHTML = 'Loading all bills...';

        try {
            const response = await fetch('http://localhost:8085/api/bills');
            if (response.ok) {
                const bills = await response.json();
                displayAllBills(bills);
            }
        } catch (error) {
            container.innerHTML = 'Error loading bills';
        }
    }

    function displayAllBills(bills) {
        const container = document.getElementById('reportResults');
        const totalRevenue = bills.reduce((sum, bill) => sum + (parseFloat(bill.totalAmount) || 0), 0);
        const cash = bills.filter(b => b.paymentMethod === 'CASH').length;
        const card = bills.filter(b => b.paymentMethod === 'CARD').length;

        currentReportData = {
            type: 'ALL',
            bills: bills,
            stats: {
                totalBills: bills.length,
                totalRevenue: totalRevenue,
                cashCount: cash,
                cardCount: card
            }
        };

        let html = `
            <h3>üìä All Bills (${bills.length})</h3>
            <div style="background: #e8f4fc; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <p><strong>Total Revenue:</strong> Rs. ${totalRevenue.toFixed(2)}</p>
                <p><strong>Cash Payments:</strong> ${cash}</p>
                <p><strong>Card Payments:</strong> ${card}</p>
            </div>
        `;

        if (bills.length > 0) {
            html += `
                <h4>Recent Bills (Last 10)</h4>
                <table class="data-table">
                    <tr><th>Bill #</th><th>Date</th><th>Amount</th><th>Payment</th></tr>
            `;

            bills.slice(0, 10).forEach(bill => {
                const date = bill.billTime ? new Date(bill.billTime).toLocaleDateString() : 'N/A';
                html += `
                    <tr>
                        <td>${bill.billId?.substring(0, 8) || 'N/A'}</td>
                        <td>${date}</td>
                        <td>Rs. ${parseFloat(bill.totalAmount || 0).toFixed(2)}</td>
                        <td>${bill.paymentMethod || 'N/A'}</td>
                    </tr>
                `;
            });

            html += '</table>';
        }

        container.innerHTML = html;
        document.getElementById('reportActions').style.display = 'block';
    }

    function printReport() {
        if (!currentReportData) {
            showError('No report to print');
            return;
        }

        const printWindow = window.open('', '_blank');
        let reportHTML = `
            <html><head><title>Restaurant Report</title>
            <style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th{background:#333;color:white;padding:10px}td{padding:8px;border:1px solid #ddd}</style></head>
            <body><h1>Restaurant Sales Report</h1>
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            <p><strong>Report Type:</strong> ${currentReportData.type}</p>
        `;

        if (currentReportData.type === 'DAILY') {
            reportHTML += `<p><strong>Date:</strong> ${currentReportData.date}</p>`;
        } else if (currentReportData.type === 'WEEKLY') {
            reportHTML += `<p><strong>Period:</strong> ${currentReportData.period}</p>`;
        } else if (currentReportData.type === 'MONTHLY') {
            reportHTML += `<p><strong>Period:</strong> ${currentReportData.period}</p>`;
        }

        if (currentReportData.stats) {
            reportHTML += `
                <h2>Summary</h2>
                <p><strong>Total Bills:</strong> ${currentReportData.stats.totalBills}</p>
                <p><strong>Total Revenue:</strong> Rs. ${currentReportData.stats.totalRevenue?.toFixed(2) || '0.00'}</p>
                <p><strong>Cash Payments:</strong> ${currentReportData.stats.cashCount || 0}</p>
                <p><strong>Card Payments:</strong> ${currentReportData.stats.cardCount || 0}</p>
            `;
        }

        if (currentReportData.bills && currentReportData.bills.length > 0) {
            reportHTML += `
                <h2>Bills</h2>
                <table>
                <tr><th>Bill ID</th><th>Date</th><th>Amount</th><th>Payment</th></tr>
            `;

            currentReportData.bills.slice(0, 20).forEach(bill => {
                const date = bill.billTime ? new Date(bill.billTime).toLocaleDateString() : 'N/A';
                reportHTML += `
                    <tr>
                        <td>${bill.billId?.substring(0, 8) || 'N/A'}</td>
                        <td>${date}</td>
                        <td>Rs. ${parseFloat(bill.totalAmount || 0).toFixed(2)}</td>
                        <td>${bill.paymentMethod || 'N/A'}</td>
                    </tr>
                `;
            });

            reportHTML += '</table>';
        }

        reportHTML += '</body></html>';

        printWindow.document.write(reportHTML);
        printWindow.document.close();
        printWindow.print();
    }

    function downloadReport() {
        if (!currentReportData) {
            showError('No report to download');
            return;
        }

        let reportText = 'Restaurant Sales Report\n';
        reportText += '=======================\n';
        reportText += `Generated: ${new Date().toLocaleString()}\n`;
        reportText += `Report Type: ${currentReportData.type}\n\n`;

        if (currentReportData.type === 'DAILY') {
            reportText += `Date: ${currentReportData.date}\n`;
        } else if (currentReportData.type === 'WEEKLY') {
            reportText += `Period: ${currentReportData.period}\n`;
        } else if (currentReportData.type === 'MONTHLY') {
            reportText += `Period: ${currentReportData.period}\n`;
        }

        if (currentReportData.stats) {
            reportText += '\nSummary:\n';
            reportText += `Total Bills: ${currentReportData.stats.totalBills}\n`;
            reportText += `Total Revenue: Rs. ${currentReportData.stats.totalRevenue?.toFixed(2) || '0.00'}\n`;
            reportText += `Cash Payments: ${currentReportData.stats.cashCount || 0}\n`;
            reportText += `Card Payments: ${currentReportData.stats.cardCount || 0}\n`;
        }

        const blob = new Blob([reportText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `restaurant-report-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showSuccess('Report downloaded!');
    }

    // ==================== INVENTORY REDUCTION ====================
    // This function should be called when an order is marked as served
    // Add this to your waiter system when marking order as served:
    async function reduceInventoryForOrder(orderId) {
        try {
            // Get order items
            const orderResponse = await fetch(`http://localhost:8084/api/orders`);
            if (!orderResponse.ok) return;

            const allOrders = await orderResponse.json();
            const order = allOrders.find(o => o.orderId === orderId);
            if (!order) return;

            // Get order items (you need this endpoint)
            const itemsResponse = await fetch(`http://localhost:8084/api/orders/items`);
            if (!itemsResponse.ok) return;

            const allItems = await itemsResponse.json();
            const orderItems = allItems.filter(item => item.order?.orderId === orderId);

            // For each item, reduce ingredients
            for (const item of orderItems) {
                // Get menu item ingredients
                const menuResponse = await fetch(`http://localhost:8083/api/menu/${item.itemId}/ingredients`);
                if (!menuResponse.ok) continue;

                const ingredients = await menuResponse.json();

                // Reduce each ingredient
                for (const ingredient of ingredients) {
                    await updateIngredientStock(
                        ingredient.ingredientId,
                        ingredient.quantityRequired * item.quantity
                    );
                }
            }

            console.log('Inventory reduced for order:', orderId);
        } catch (error) {
            console.error('Error reducing inventory:', error);
        }
    }

    async function updateIngredientStock(ingredientId, quantityToReduce) {
        try {
            // Get current ingredient
            const response = await fetch(`http://localhost:8083/api/menu/ingredients/${ingredientId}`);
            if (!response.ok) return;

            const ingredient = await response.json();
            const newQuantity = parseFloat(ingredient.currentQuantity) - parseFloat(quantityToReduce);

            // Update ingredient
            await fetch(`http://localhost:8083/api/menu/ingredients/${ingredientId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...ingredient,
                    currentQuantity: newQuantity
                })
            });
        } catch (error) {
            console.error('Error updating ingredient:', error);
        }
    }

    // ==================== UTILITIES ====================
    function showSuccess(message) {
        const element = document.getElementById('successMessage');
        element.textContent = message;
        element.style.display = 'block';
        setTimeout(() => element.style.display = 'none', 3000);
    }

    function showError(message) {
        const element = document.getElementById('errorMessage');
        element.textContent = message;
        element.style.display = 'block';
        setTimeout(() => element.style.display = 'none', 3000);
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function logout() {
        localStorage.removeItem('restaurantUser');
        window.location.href = '/';
    }
</script>
</body>
</html>