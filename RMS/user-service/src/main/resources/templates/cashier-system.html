<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashier System - Restaurant Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f5f7fa;
            color: #333;
        }

        /* Header */
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Container */
        .container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: #3498db;
            color: white;
            border-bottom: 3px solid #2980b9;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Orders List */
        .orders-list {
            margin-top: 20px;
        }

        .order-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .order-id {
            font-weight: bold;
            color: #2c3e50;
        }

        .order-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            background: #27ae60;
            color: white;
        }

        /* Bill Form */
        .bill-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f5f7fa;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Bill Items */
        .bill-items {
            margin: 20px 0;
        }

        .bill-summary {
            background: #e8f4fc;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .total-row {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            border-bottom: 2px solid #2c3e50;
        }
    </style>
</head>
<body>
<!-- Header -->
<div class="header">
    <h1>ðŸ’µ Cashier System - Restaurant Management</h1>
    <div class="user-info">
        <div id="welcomeUser">Cashier</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
</div>

<!-- Container -->
<div class="container">
    <!-- Messages -->
    <div id="successMessage" class="message success"></div>
    <div id="errorMessage" class="message error"></div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('billing')">Billing</div>
        <div class="tab" onclick="switchTab('reports')">Reports</div>
        <div class="tab" onclick="switchTab('history')">History</div>
    </div>

    <!-- TAB 1: Billing -->
    <div id="billing-tab" class="tab-content active">
        <h2>Generate Bill</h2>

        <!-- Ready Orders -->
        <h3 style="margin-top: 20px;">Ready Orders</h3>
        <div id="loadingOrders" class="loading">Loading ready orders...</div>
        <div id="readyOrders" class="orders-list" style="display: none;"></div>

        <!-- Bill Form -->
        <div id="billForm" class="bill-form" style="display: none;">
            <h3>Bill Details</h3>

            <div class="form-row">
                <div class="form-group">
                    <label>Order ID</label>
                    <input type="text" id="orderId" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Table Number</label>
                    <input type="text" id="tableNumber" class="form-control" readonly>
                </div>
            </div>

            <div class="bill-items">
                <h4>Order Items</h4>
                <div id="orderItemsList"></div>
            </div>

            <div class="bill-summary">
                <h4>Bill Summary</h4>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span>Rs. <span id="subtotal">0.00</span></span>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tax (%)</label>
                        <input type="number" id="taxPercent" class="form-control" value="10" min="0" max="50" onchange="calculateTotal()">
                    </div>
                    <div class="form-group">
                        <label>Discount (Rs.)</label>
                        <input type="number" id="discountAmount" class="form-control" value="0" min="0" onchange="calculateTotal()">
                    </div>
                </div>
                <div class="summary-row">
                    <span>Tax Amount:</span>
                    <span>Rs. <span id="taxAmount">0.00</span></span>
                </div>
                <div class="summary-row">
                    <span>Discount:</span>
                    <span>Rs. <span id="discount">0.00</span></span>
                </div>
                <div class="summary-row total-row">
                    <span>Total Amount:</span>
                    <span>Rs. <span id="totalAmount">0.00</span></span>
                </div>
            </div>

            <div class="form-group">
                <label>Payment Method</label>
                <select id="paymentMethod" class="form-control">
                    <option value="CASH">Cash</option>
                    <option value="CARD">Card</option>
                </select>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="generateBill()">Generate Bill</button>
                <button class="btn" onclick="cancelBill()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- TAB 2: Reports -->
    <div id="reports-tab" class="tab-content">
        <h2>Daily Sales Report</h2>

        <div style="margin: 20px 0;">
            <button class="btn btn-primary" onclick="generateDailyReport()">
                Generate Today's Report
            </button>
            <button class="btn" onclick="loadAllBills()">
                View All Bills
            </button>
        </div>

        <div id="loadingReport" class="loading">Select an option above</div>
        <div id="reportResults" style="display: none;"></div>
    </div>

    <!-- TAB 3: History -->
    <div id="history-tab" class="tab-content">
        <h2>Billing History</h2>

        <div id="loadingHistory" class="loading">Loading billing history...</div>
        <div id="billingHistory" style="display: none;"></div>
    </div>
</div>

<!-- JavaScript -->
<script>
    // Global variables
    let currentUser = null;
    let selectedOrder = null;
    let currentOrderItems = [];
    let subtotal = 0;

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        checkLoginStatus();
    });

    function checkLoginStatus() {
        const userData = localStorage.getItem('restaurantUser');
        if (!userData) {
            window.location.href = '/';
            return;
        }

        try {
            currentUser = JSON.parse(userData);

            // Check if user is a cashier
            if (currentUser.role !== 'CASHIER') {
                localStorage.removeItem('restaurantUser');
                window.location.href = '/';
                return;
            }

            // Update welcome message
            document.getElementById('welcomeUser').textContent = `Cashier: ${currentUser.fullName}`;

            // Load initial data
            loadReadyOrders();
            loadBillingHistory();
        } catch (error) {
            localStorage.removeItem('restaurantUser');
            window.location.href = '/';
        }
    }

    // ==================== TAB MANAGEMENT ====================
    function switchTab(tabName) {
        // Update tabs
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        // Activate selected tab
        event.target.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
    }

    // ==================== ORDER FUNCTIONS ====================
    async function loadReadyOrders() {
        try {
            const response = await fetch('http://localhost:8084/api/orders');
            if (response.ok) {
                const orders = await response.json();
                const readyOrders = orders.filter(order => order.status === 'READY');
                displayReadyOrders(readyOrders);
            }
        } catch (error) {
            console.error('Error loading orders:', error);
            document.getElementById('loadingOrders').innerHTML = 'Error loading orders';
        }
    }

    function displayReadyOrders(orders) {
        const container = document.getElementById('readyOrders');
        const loading = document.getElementById('loadingOrders');

        loading.style.display = 'none';

        if (orders.length === 0) {
            container.innerHTML = '<p>No ready orders found.</p>';
        } else {
            let html = '';
            orders.forEach(order => {
                html += `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">Order #${order.orderId.substring(0, 8)}</div>
                            <div class="order-status">READY</div>
                        </div>
                        <p><strong>Table:</strong> ${order.tableId}</p>
                        <p><strong>Amount:</strong> Rs. ${order.totalAmount?.toFixed(2) || '0.00'}</p>
                        <p><strong>Time:</strong> ${new Date(order.createdAt).toLocaleTimeString()}</p>
                        <button class="btn btn-primary" onclick="selectOrderForBilling('${order.orderId}')" style="margin-top: 10px;">
                            Create Bill
                        </button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        container.style.display = 'block';
    }

    async function selectOrderForBilling(orderId) {
        try {
            // Get order details
            const response = await fetch(`http://localhost:8084/api/orders`);
            if (response.ok) {
                const orders = await response.json();
                selectedOrder = orders.find(order => order.orderId === orderId);

                if (selectedOrder) {
                    // Show bill form
                    document.getElementById('billForm').style.display = 'block';

                    // Fill form data
                    document.getElementById('orderId').value = selectedOrder.orderId;
                    document.getElementById('tableNumber').value = selectedOrder.tableId;

                    // Set subtotal
                    subtotal = selectedOrder.totalAmount || 0;
                    document.getElementById('subtotal').textContent = subtotal.toFixed(2);

                    // Calculate total
                    calculateTotal();

                    // Scroll to form
                    document.getElementById('billForm').scrollIntoView({ behavior: 'smooth' });
                }
            }
        } catch (error) {
            showError('Error selecting order: ' + error.message);
        }
    }

    // ==================== BILL CALCULATION ====================
    function calculateTotal() {
        const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;
        const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;

        // Calculate tax amount
        const taxAmount = (subtotal * taxPercent) / 100;
        document.getElementById('taxAmount').textContent = taxAmount.toFixed(2);

        // Calculate discount
        const discount = Math.min(discountAmount, subtotal + taxAmount);
        document.getElementById('discount').textContent = discount.toFixed(2);

        // Calculate total
        const totalAmount = subtotal + taxAmount - discount;
        document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
    }

    // ==================== BILL GENERATION ====================
    async function generateBill() {
        if (!selectedOrder) {
            showError('No order selected');
            return;
        }

        const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;
        const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
        const paymentMethod = document.getElementById('paymentMethod').value;

        // Calculate final amounts
        const taxAmount = (subtotal * taxPercent) / 100;
        const discount = Math.min(discountAmount, subtotal + taxAmount);
        const totalAmount = subtotal + taxAmount - discount;

        try {
            // Create bill data
            const billData = {
                orderId: selectedOrder.orderId,
                cashierId: currentUser.userId,
                subtotal: subtotal,
                taxAmount: taxAmount,
                discountAmount: discount,
                totalAmount: totalAmount,
                paymentMethod: paymentMethod,
                paymentStatus: 'PAID'
            };

            console.log('Creating bill:', billData);

            // Send to billing service
            const response = await fetch('http://localhost:8085/api/bills', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(billData)
            });

            if (response.ok) {
                const bill = await response.json();
                showSuccess(`Bill #${bill.billId.substring(0, 8)} generated successfully!`);

                // Update order status to SERVED
                await fetch(`http://localhost:8084/api/orders/${selectedOrder.orderId}/status/SERVED`, {
                    method: 'PUT'
                });

                // Reset form and reload
                cancelBill();
                loadReadyOrders();
                loadBillingHistory();

                // Print receipt (simulated)
                printReceipt(bill);
            } else {
                const errorText = await response.text();
                showError('Failed to generate bill: ' + errorText);
            }
        } catch (error) {
            showError('Error generating bill: ' + error.message);
        }
    }

    function printReceipt(bill) {
        // Create a simple receipt for printing
        const receiptWindow = window.open('', '_blank');
        receiptWindow.document.write(`
            <html>
            <head>
                <title>Receipt - Bill #${bill.billId.substring(0, 8)}</title>
                <style>
                    body { font-family: 'Courier New', monospace; padding: 20px; }
                    .receipt { max-width: 300px; margin: 0 auto; }
                    .center { text-align: center; }
                    .line { border-bottom: 1px dashed #000; margin: 10px 0; }
                    .total { font-weight: bold; font-size: 18px; }
                </style>
            </head>
            <body>
                <div class="receipt">
                    <h2 class="center">RESTAURANT RECEIPT</h2>
                    <div class="line"></div>
                    <p><strong>Bill #:</strong> ${bill.billId.substring(0, 8)}</p>
                    <p><strong>Order #:</strong> ${bill.orderId.substring(0, 8)}</p>
                    <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Cashier:</strong> ${currentUser.fullName}</p>
                    <div class="line"></div>

                    <p><strong>Subtotal:</strong> Rs. ${bill.subtotal.toFixed(2)}</p>
                    <p><strong>Tax (${(bill.taxAmount/bill.subtotal*100).toFixed(1)}%):</strong> Rs. ${bill.taxAmount.toFixed(2)}</p>
                    <p><strong>Discount:</strong> Rs. ${bill.discountAmount.toFixed(2)}</p>
                    <div class="line"></div>

                    <p class="total">TOTAL: Rs. ${bill.totalAmount.toFixed(2)}</p>
                    <p><strong>Payment:</strong> ${bill.paymentMethod}</p>
                    <p><strong>Status:</strong> ${bill.paymentStatus}</p>

                    <div class="line"></div>
                    <p class="center">Thank you for dining with us!</p>
                    <p class="center">Please visit again</p>
                </div>
            </body>
            </html>
        `);
        receiptWindow.document.close();
        receiptWindow.print();
    }

    function cancelBill() {
        selectedOrder = null;
        document.getElementById('billForm').style.display = 'none';
    }

    // ==================== REPORTS FUNCTIONS ====================
    async function generateDailyReport() {
        try {
            const response = await fetch('http://localhost:8085/api/bills');
            if (response.ok) {
                const bills = await response.json();
                displayDailyReport(bills);
            }
        } catch (error) {
            console.error('Error loading bills:', error);
        }
    }

    function displayDailyReport(bills) {
        const loading = document.getElementById('loadingReport');
        const results = document.getElementById('reportResults');

        loading.style.display = 'none';

        // Filter today's bills
        const today = new Date().toDateString();
        const todayBills = bills.filter(bill => {
            const billDate = new Date(bill.billTime).toDateString();
            return billDate === today;
        });

        let html = `
            <h3>Today's Sales (${today})</h3>
            <div style="background: #e8f4fc; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <p><strong>Total Bills:</strong> ${todayBills.length}</p>
                <p><strong>Total Revenue:</strong> Rs. ${todayBills.reduce((sum, bill) => sum + (bill.totalAmount || 0), 0).toFixed(2)}</p>
                <p><strong>Cash Payments:</strong> Rs. ${todayBills.filter(b => b.paymentMethod === 'CASH').reduce((sum, bill) => sum + (bill.totalAmount || 0), 0).toFixed(2)}</p>
                <p><strong>Card Payments:</strong> Rs. ${todayBills.filter(b => b.paymentMethod === 'CARD').reduce((sum, bill) => sum + (bill.totalAmount || 0), 0).toFixed(2)}</p>
            </div>
        `;

        if (todayBills.length > 0) {
            html += `
                <h4>Today's Bills</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Bill #</th>
                            <th>Order #</th>
                            <th>Amount</th>
                            <th>Payment</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            todayBills.forEach(bill => {
                html += `
                    <tr>
                        <td>${bill.billId.substring(0, 8)}</td>
                        <td>${bill.orderId ? bill.orderId.substring(0, 8) : 'N/A'}</td>
                        <td>Rs. ${bill.totalAmount?.toFixed(2) || '0.00'}</td>
                        <td>${bill.paymentMethod}</td>
                        <td>${new Date(bill.billTime).toLocaleTimeString()}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
        }

        results.innerHTML = html;
        results.style.display = 'block';
    }

    async function loadAllBills() {
        try {
            const response = await fetch('http://localhost:8085/api/bills');
            if (response.ok) {
                const bills = await response.json();
                displayAllBills(bills);
            }
        } catch (error) {
            console.error('Error loading bills:', error);
        }
    }

    function displayAllBills(bills) {
        const loading = document.getElementById('loadingReport');
        const results = document.getElementById('reportResults');

        loading.style.display = 'none';

        let html = `
            <h3>All Bills (${bills.length})</h3>
            <div style="background: #e8f4fc; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <p><strong>Total Revenue:</strong> Rs. ${bills.reduce((sum, bill) => sum + (bill.totalAmount || 0), 0).toFixed(2)}</p>
            </div>
        `;

        if (bills.length > 0) {
            html += `
                <table>
                    <thead>
                        <tr>
                            <th>Bill #</th>
                            <th>Order #</th>
                            <th>Amount</th>
                            <th>Payment</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            bills.forEach(bill => {
                html += `
                    <tr>
                        <td>${bill.billId.substring(0, 8)}</td>
                        <td>${bill.orderId ? bill.orderId.substring(0, 8) : 'N/A'}</td>
                        <td>Rs. ${bill.totalAmount?.toFixed(2) || '0.00'}</td>
                        <td>${bill.paymentMethod}</td>
                        <td>${new Date(bill.billTime).toLocaleDateString()}</td>
                        <td>${bill.paymentStatus}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
        }

        results.innerHTML = html;
        results.style.display = 'block';
    }

    // ==================== HISTORY FUNCTIONS ====================
    async function loadBillingHistory() {
        try {
            const response = await fetch('http://localhost:8085/api/bills');
            if (response.ok) {
                const bills = await response.json();
                displayBillingHistory(bills);
            }
        } catch (error) {
            console.error('Error loading billing history:', error);
        }
    }

    function displayBillingHistory(bills) {
        const loading = document.getElementById('loadingHistory');
        const container = document.getElementById('billingHistory');

        loading.style.display = 'none';

        if (bills.length === 0) {
            container.innerHTML = '<p>No billing history found.</p>';
        } else {
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Bill #</th>
                            <th>Order #</th>
                            <th>Amount</th>
                            <th>Payment</th>
                            <th>Date & Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Sort by date (newest first)
            bills.sort((a, b) => new Date(b.billTime) - new Date(a.billTime));

            bills.forEach(bill => {
                html += `
                    <tr>
                        <td>${bill.billId.substring(0, 8)}</td>
                        <td>${bill.orderId ? bill.orderId.substring(0, 8) : 'N/A'}</td>
                        <td>Rs. ${bill.totalAmount?.toFixed(2) || '0.00'}</td>
                        <td>${bill.paymentMethod}</td>
                        <td>${new Date(bill.billTime).toLocaleString()}</td>
                        <td>${bill.paymentStatus}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        container.style.display = 'block';
    }

    // ==================== UTILITY FUNCTIONS ====================
    function showSuccess(message) {
        const element = document.getElementById('successMessage');
        element.textContent = message;
        element.style.display = 'block';
        setTimeout(() => element.style.display = 'none', 5000);
    }

    function showError(message) {
        const element = document.getElementById('errorMessage');
        element.textContent = message;
        element.style.display = 'block';
        setTimeout(() => element.style.display = 'none', 5000);
    }

    function logout() {
        localStorage.removeItem('restaurantUser');
        window.location.href = '/';
    }
</script>
</body>
</html>